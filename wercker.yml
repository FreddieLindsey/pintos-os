box: freddielindsey/pintos

build:
  steps:
    - script: Check tools available
      code: |
        export PATH="$(pwd)/src/utils:$PATH"
        echo -e "CWD:\t$(pwd)"
        echo -e "Pintos:\t$(which pintos)"
    - script:
      name: Check tools available
      code: |
        echo $PATH
        which pintos
    - script:
      name: Compiling src/devices
      code: |
        make -C src/devices
    - script:
      name: Compiling src/threads
      code: |
        make -C src/threads
    - script:
      name: Testing src/threads/fixed-point
      code: |
        gcc -Wall -Werror -pedantic -std=c99 src/threads/fixed-point-tests.c -o fixed-point-tests
        ./fixed-point-tests
        rm fixed-point-tests
    - script:
      name: Compiling design documents
      code: |
        make -C doc alarmclock.pdf
  after-steps:
    - slack-notifier:
      url: $SLACK_URL
      username: wercker

deploy:
  steps:

    - script:
    name: Testing src/devices
    code: |
      make -C src/devices check
    - script:
    name: Testing src/threads
    code: |
      make -C src/threads check


    - add-to-known_hosts:
        hostname: gitlab.doc.ic.ac.uk
    - mktemp:
      envvar: PRIVATEKEY_PATH
    - create-file:
      name: write key
      filename: $PRIVATEKEY_PATH
      content: $GITLAB_KEY_PRIVATE
      overwrite: true
      hide-from-log: true
    - script:
      name: Create Identity File
      code: |
        echo -e "\nHost gitlab-pintos" >> $HOME/.ssh/config
        echo -e "\tHostname gitlab.doc.ic.ac.uk" >> $HOME/.ssh/config
        echo -e "\tIdentityFile $PRIVATEKEY_PATH" >> $HOME/.ssh/config
        echo -e "\tUser fl1414" >> $HOME/.ssh/config
        echo -e "\n\nCONFIG:"
        cat $HOME/.ssh/config
    - script:
      name: Pushing to gitlab
      code: |
        git remote add gitlab git@gitlab-pintos:lab1516_spring/pintos_12.git
        git push gitlab master
  after-steps:
    - slack-notifier:
      url: $SLACK_URL
      username: wercker_deployment
